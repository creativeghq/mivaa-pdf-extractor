name: üöÄ MIVAA Deployment (Default)

on:
  push:
    branches: [ "main", "production"]
  workflow_dispatch:
    inputs:
      deployment_reason:
        description: 'üìù Reason for manual deployment'
        required: false
        default: 'Manual deployment using standard pipeline'
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          FIRECRAWL_API_KEY: ${{ secrets.FIRECRAWL_API_KEY }}
          HUGGINGFACE_API_KEY: ${{ secrets.HUGGINGFACE_API_KEY }}
          HUGGING_FACE_ACCESS_TOKEN: ${{ secrets.HUGGING_FACE_ACCESS_TOKEN }}
          JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          MATERIAL_KAI_API_KEY: ${{ secrets.MATERIAL_KAI_API_KEY }}
          MATERIAL_KAI_API_URL: ${{ secrets.MATERIAL_KAI_API_URL }}
          MATERIAL_KAI_CLIENT_ID: ${{ secrets.MATERIAL_KAI_CLIENT_ID }}
          MATERIAL_KAI_CLIENT_SECRET: ${{ secrets.MATERIAL_KAI_CLIENT_SECRET }}
          MATERIAL_KAI_WEBHOOK_SECRET: ${{ secrets.MATERIAL_KAI_WEBHOOK_SECRET }}
          MATERIAL_KAI_WORKSPACE_ID: ${{ secrets.MATERIAL_KAI_WORKSPACE_ID }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}

      # 2. Setup SSH
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      # 3. Deployment Overview & Summary
      - name: üìã Deployment Overview & Summary
        run: |
          echo "üöÄ MIVAA PDF Extractor Deployment Overview (DEFAULT)"
          echo "=================================================="
          echo ""
          echo "üéØ Deployment Type: STANDARD (Default Pipeline)"
          echo "üìù Trigger: ${{ github.event_name == 'push' && 'Automatic (Code Push)' || 'Manual (workflow_dispatch)' }}"
          echo "${{ github.event.inputs.deployment_reason && format('üìù Reason: {0}', github.event.inputs.deployment_reason) || '' }}"
          echo ""
          echo "üìä Deployment Details:"
          echo "  ‚Ä¢ Target Environment: Production"
          echo "  ‚Ä¢ Target Server: 104.248.68.3"
          echo "  ‚Ä¢ Branch: ${{ github.ref_name }}"
          echo "  ‚Ä¢ Commit: ${{ github.sha }}"
          echo "  ‚Ä¢ Triggered by: ${{ github.actor }}"
          echo "  ‚Ä¢ Deployment ID: ${{ github.run_id }}"

          # Add to GitHub Step Summary (visible on main action page)
          echo "# üöÄ MIVAA Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìä Deployment Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **üéØ Deployment Type** | STANDARD (Default Pipeline) |" >> $GITHUB_STEP_SUMMARY
          echo "| **üìù Trigger** | ${{ github.event_name == 'push' && 'Automatic (Code Push)' || 'Manual (workflow_dispatch)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **üåø Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **üìã Commit** | [\`${{ github.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **üë§ Triggered by** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **üÜî Deployment ID** | \`${{ github.run_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **üéØ Target Environment** | Production |" >> $GITHUB_STEP_SUMMARY
          echo "| **üñ•Ô∏è Target Server** | 104.248.68.3 |" >> $GITHUB_STEP_SUMMARY
          echo "| **‚è∞ Started** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Add reason if provided
          if [[ -n "${{ github.event.inputs.deployment_reason }}" ]]; then
            echo "| **üìù Deployment Reason** | ${{ github.event.inputs.deployment_reason }} |" >> $GITHUB_STEP_SUMMARY
          fi
          echo ""
          echo "üèóÔ∏è Application Architecture:"
          echo "  ‚Ä¢ Service: MIVAA PDF Extractor (FastAPI)"
          echo "  ‚Ä¢ Runtime: Python 3.9 with pyenv"
          echo "  ‚Ä¢ Package Manager: uv (ultrafast Python package installer)"
          echo "  ‚Ä¢ Process Manager: systemd (mivaa-pdf-extractor.service)"
          echo "  ‚Ä¢ Deployment Path: /var/www/mivaa-pdf-extractor"
          echo ""
          echo "üîß Key Components:"
          echo "  ‚Ä¢ PDF Processing: PyMuPDF + pymupdf4llm"
          echo "  ‚Ä¢ AI/ML: LlamaIndex, OpenAI, HuggingFace, Replicate"
          echo "  ‚Ä¢ Database: Supabase (PostgreSQL)"
          echo "  ‚Ä¢ Authentication: JWT with custom middleware"
          echo "  ‚Ä¢ Monitoring: Sentry error tracking"
          echo "  ‚Ä¢ API Endpoints: 37+ endpoints across 7 modules"

          # Add architecture to summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üèóÔ∏è Application Architecture" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| **üöÄ Service** | MIVAA PDF Extractor (FastAPI) |" >> $GITHUB_STEP_SUMMARY
          echo "| **üêç Runtime** | Python 3.9 with pyenv |" >> $GITHUB_STEP_SUMMARY
          echo "| **üì¶ Package Manager** | uv (ultrafast Python package installer) |" >> $GITHUB_STEP_SUMMARY
          echo "| **‚öôÔ∏è Process Manager** | systemd (mivaa-pdf-extractor.service) |" >> $GITHUB_STEP_SUMMARY
          echo "| **üìÅ Deployment Path** | /var/www/mivaa-pdf-extractor |" >> $GITHUB_STEP_SUMMARY
          echo "| **üìÑ PDF Processing** | PyMuPDF + pymupdf4llm |" >> $GITHUB_STEP_SUMMARY
          echo "| **ü§ñ AI/ML** | LlamaIndex, OpenAI, HuggingFace, Replicate |" >> $GITHUB_STEP_SUMMARY
          echo "| **üóÑÔ∏è Database** | Supabase (PostgreSQL) |" >> $GITHUB_STEP_SUMMARY
          echo "| **üîê Authentication** | JWT with custom middleware |" >> $GITHUB_STEP_SUMMARY
          echo "| **üìä Monitoring** | Sentry error tracking |" >> $GITHUB_STEP_SUMMARY
          echo "| **üåê API Endpoints** | 37+ endpoints across 7 modules |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Add initial package status table (will be updated after installation)
          echo "## üì¶ Package Installation Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Category | Description | Status | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|----------|-------------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Deployment** | üîÑ In Progress | Starting deployment process... | ÔøΩ Initializing... | N/A |" >> $GITHUB_STEP_SUMMARY
          echo "| **System Setup** | System | Installing system dependencies | üü° Pending... | N/A |" >> $GITHUB_STEP_SUMMARY
          echo "| **Python Packages** | Dependencies | Installing Python packages | üü° Pending... | N/A |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> üìù **Note**: This table will be updated in real-time as deployment progresses. Check back for live status updates!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo ""
          echo "üîê Environment Variables (Configured):"
          echo "  ‚Ä¢ SUPABASE_URL: ‚úÖ Configured"
          echo "  ‚Ä¢ SUPABASE_ANON_KEY: ‚úÖ Configured"
          echo "  ‚Ä¢ SUPABASE_SERVICE_ROLE_KEY: ‚úÖ Configured"
          echo "  ‚Ä¢ ANTHROPIC_API_KEY: ‚úÖ Configured"
          echo "  ‚Ä¢ OPENAI_API_KEY: ‚úÖ Configured"
          echo "  ‚Ä¢ HUGGINGFACE_API_KEY: ‚úÖ Configured"
          echo "  ‚Ä¢ REPLICATE_API_TOKEN: ‚úÖ Configured"
          echo "  ‚Ä¢ JWT_SECRET_KEY: ‚úÖ Configured"
          echo "  ‚Ä¢ SENTRY_DSN: ‚úÖ Configured"
          echo "  ‚Ä¢ MATERIAL_KAI_API_*: ‚úÖ Configured"
          echo ""
          echo "üì¶ Deployment Process:"
          echo "  1. üì• Code checkout and SSH setup"
          echo "  2. üîÑ Git repository sync on server"
          echo "  3. üêç Python environment setup (pyenv + venv)"
          echo "  4. üìã Dependency compilation (uv.lock generation)"
          echo "  5. ‚ö° Ultra-fast dependency installation (uv)"
          echo "  6. üîß Critical package installation (OpenCV, FastAPI, etc.)"
          echo "  7. ‚úÖ Comprehensive package verification (all requirements.txt)"
          echo "  8. üîÑ Service restart (systemd)"
          echo "  9. üè• Health check and status verification"
          echo "  10. üìä Package status reporting in deployment summary"
          echo ""
          echo "üéØ Expected Outcomes:"
          echo "  ‚Ä¢ Zero-downtime deployment"
          echo "  ‚Ä¢ All 37+ API endpoints operational"
          echo "  ‚Ä¢ PDF processing capabilities active"
          echo "  ‚Ä¢ AI/ML models ready for inference"
          echo "  ‚Ä¢ Database connections established"
          echo "  ‚Ä¢ Authentication system functional"
          echo ""
          echo "‚è±Ô∏è Starting deployment process..."
          echo ""

      # 4.1. Setup deployment environment
      - name: üîß Setup deployment environment
        run: |
          ssh -o StrictHostKeyChecking=no root@104.248.68.3 "
          set -e

          # Function to handle errors
          handle_error() {
            echo \"‚ùå Error occurred: \\\$1\"
            echo \"üìù Creating error report...\"

            # Create simple error report
            echo '| Package | Category | Description | Status | Version |' > package_status_report.txt
            echo '|---------|----------|-------------|--------|---------|' >> package_status_report.txt
            echo '| **System Dependencies** | System | Ubuntu packages for PyMuPDF | üî¥ Failed | N/A |' >> package_status_report.txt
            echo '| **Python Environment** | Runtime | Virtual environment setup | üü° Partial | N/A |' >> package_status_report.txt
            echo '| **Package Installation** | Dependencies | Python package installation | üî¥ Failed | N/A |' >> package_status_report.txt
            echo '| **Deployment Status** | Overall | Complete deployment process | üî¥ Failed | N/A |' >> package_status_report.txt

            # Capture error logs
            echo \"üìã Capturing error logs...\"
            echo '=== DEPLOYMENT ERROR LOGS ===' > deployment_error_logs.txt
            echo \"Error: \\\$1\" >> deployment_error_logs.txt
            echo \"Time: \\\$(date)\" >> deployment_error_logs.txt
            echo \"Working Directory: \\\$(pwd)\" >> deployment_error_logs.txt
            echo \"Python Version: \\\$(python --version 2>&1)\" >> deployment_error_logs.txt
            echo \"Pip Version: \\\$(pip --version 2>&1)\" >> deployment_error_logs.txt
            echo \"Virtual Environment: \\\$(which python)\" >> deployment_error_logs.txt
            echo \"Recent pip install output:\" >> deployment_error_logs.txt
            tail -20 /tmp/pip-install.log 2>/dev/null >> deployment_error_logs.txt || echo 'No pip install log available' >> deployment_error_logs.txt

            echo \"üìä Error report and logs created\"
            exit 1
          }

          # Trap errors
          trap 'handle_error \"Deployment script failed at line \\\$LINENO\"' ERR

          APP_DIR=/var/www/mivaa-pdf-extractor
          DEPLOY_BRANCH=\"${{ github.ref_name }}\"

          # Clone repo if it doesn't exist
          if [ ! -d \"\$APP_DIR/.git\" ]; then
            rm -rf \"\$APP_DIR\"
            git clone https://x-access-token:${{ secrets.GH_PAT }}@github.com/creativeghq/mivaa-pdf-extractor.git \"\$APP_DIR\"
          fi

          cd \"\$APP_DIR\"

          # Pull latest changes for the branch
          git fetch origin \"\$DEPLOY_BRANCH\"
          git reset --hard origin/\"\$DEPLOY_BRANCH\"

          # --- Initialize pyenv ---
          export PATH=\"\$HOME/.pyenv/bin:\$PATH\"
          eval \"\$(pyenv init --path)\"
          eval \"\$(pyenv init -)\"
          eval \"\$(pyenv virtualenv-init -)\"

          # Use pyenv Python
          PYTHON=python3.9

          # --- Create virtual environment ---
          if [ ! -d \".venv\" ] || [ ! -f \".venv/pyvenv.cfg\" ]; then
            rm -rf .venv
            \$PYTHON -m venv .venv
          fi

          # Activate venv
          source .venv/bin/activate

          # Set library path for MuPDF
          export LD_LIBRARY_PATH=\"/usr/lib/x86_64-linux-gnu:\$LD_LIBRARY_PATH\"
          echo \"LD_LIBRARY_PATH set to: \$LD_LIBRARY_PATH\"

          # --- Install system dependencies for PyMuPDF ---
          echo 'Installing system dependencies for PyMuPDF...'

          # Create initial status report
          echo '| Package | Category | Description | Status | Version |' > package_status_report.txt
          echo '|---------|----------|-------------|--------|---------|' >> package_status_report.txt
          echo '| **System Dependencies** | System | Ubuntu packages for PyMuPDF | üü° Installing... | N/A |' >> package_status_report.txt
          echo '| **Python Environment** | Runtime | Virtual environment setup | üü¢ Ready | N/A |' >> package_status_report.txt
          echo '| **Package Installation** | Dependencies | Python package installation | üü° Pending... | N/A |' >> package_status_report.txt

          # Try to install system dependencies (non-critical)
          apt-get update -qq 2>/dev/null || echo 'Warning: apt update had issues'

          # Install packages individually to avoid failure if one is missing
          echo 'Installing system packages individually...'
          apt-get install -y -qq libfreetype6-dev 2>/dev/null && echo \"‚úÖ Installed: libfreetype6-dev\" || echo \"‚ö†Ô∏è Skipped: libfreetype6-dev (not available)\"
          apt-get install -y -qq libfontconfig1-dev 2>/dev/null && echo \"‚úÖ Installed: libfontconfig1-dev\" || echo \"‚ö†Ô∏è Skipped: libfontconfig1-dev (not available)\"
          apt-get install -y -qq libjpeg-dev 2>/dev/null && echo \"‚úÖ Installed: libjpeg-dev\" || echo \"‚ö†Ô∏è Skipped: libjpeg-dev (not available)\"
          apt-get install -y -qq libopenjp2-7-dev 2>/dev/null && echo \"‚úÖ Installed: libopenjp2-7-dev\" || echo \"‚ö†Ô∏è Skipped: libopenjp2-7-dev (not available)\"
          apt-get install -y -qq libharfbuzz-dev 2>/dev/null && echo \"‚úÖ Installed: libharfbuzz-dev\" || echo \"‚ö†Ô∏è Skipped: libharfbuzz-dev (not available)\"
          apt-get install -y -qq liblcms2-dev 2>/dev/null && echo \"‚úÖ Installed: liblcms2-dev\" || echo \"‚ö†Ô∏è Skipped: liblcms2-dev (not available)\"
          apt-get install -y -qq libssl-dev 2>/dev/null && echo \"‚úÖ Installed: libssl-dev\" || echo \"‚ö†Ô∏è Skipped: libssl-dev (not available)\"
          apt-get install -y -qq zlib1g-dev 2>/dev/null && echo \"‚úÖ Installed: zlib1g-dev\" || echo \"‚ö†Ô∏è Skipped: zlib1g-dev (not available)\"
          apt-get install -y -qq libffi-dev 2>/dev/null && echo \"‚úÖ Installed: libffi-dev\" || echo \"‚ö†Ô∏è Skipped: libffi-dev (not available)\"
          apt-get install -y -qq build-essential 2>/dev/null && echo \"‚úÖ Installed: build-essential\" || echo \"‚ö†Ô∏è Skipped: build-essential (not available)\"
          apt-get install -y -qq pkg-config 2>/dev/null && echo \"‚úÖ Installed: pkg-config\" || echo \"‚ö†Ô∏è Skipped: pkg-config (not available)\"

          # Try to install MuPDF system library as alternative
          echo 'Attempting to install system MuPDF library...'
          apt-get install -y -qq mupdf-tools libmupdf-dev 2>/dev/null && echo \"‚úÖ System MuPDF installed\" || echo \"‚ö†Ô∏è System MuPDF not available\"

          # Try alternative: install from Ubuntu 22.04 repository
          echo 'Attempting to install MuPDF from alternative sources...'
          wget -q http://archive.ubuntu.com/ubuntu/pool/universe/m/mupdf/libmupdf24_1.24.1+ds1-1_amd64.deb -O /tmp/libmupdf24.deb 2>/dev/null || echo 'Could not download libmupdf24'
          dpkg -i /tmp/libmupdf24.deb 2>/dev/null || echo 'Could not install libmupdf24'
          ldconfig 2>/dev/null || echo 'ldconfig failed'

          # Update status after system dependencies
          echo '| Package | Category | Description | Status | Version |' > package_status_report.txt
          echo '|---------|----------|-------------|--------|---------|' >> package_status_report.txt
          echo '| **System Dependencies** | System | Ubuntu packages for PyMuPDF | üü¢ Installed | N/A |' >> package_status_report.txt
          echo '| **Python Environment** | Runtime | Virtual environment setup | üü¢ Ready | N/A |' >> package_status_report.txt
          echo '| **Package Installation** | Dependencies | Python package installation | üü° Installing... | N/A |' >> package_status_report.txt
          "

      # 4.2. Install Python packages
      - name: üì¶ Install Python packages
        run: |
          ssh -o StrictHostKeyChecking=no root@104.248.68.3 "
          cd /var/www/mivaa-pdf-extractor
          source .venv/bin/activate
          export LD_LIBRARY_PATH=\"/usr/lib/x86_64-linux-gnu:\$LD_LIBRARY_PATH\"

          # --- Ensure pip and uv are installed ---
          python -m ensurepip --upgrade
          pip install --upgrade pip
          pip install uv

          # --- Exact version installation to prevent conflicts ---
          echo 'Installing exact versions to prevent dependency conflicts...'

          # Create pip install log file
          touch /tmp/pip-install.log

          # CRITICAL: Use --no-deps and exact versions to prevent pip from upgrading

          # Step 1: Core scientific computing with exact versions
          echo 'Step 1: Installing core scientific computing...'
          pip install --no-deps numpy==1.26.4
          pip install --no-deps pandas==2.1.4
          pip install --no-deps scipy==1.11.4

          # Step 2: PyTorch ecosystem with exact versions
          echo 'Step 2: Installing PyTorch ecosystem...'
          pip install --no-deps torch==2.2.2
          pip install --no-deps torchvision==0.17.2

          # Step 3: HTTP and API clients with exact versions
          echo 'Step 3: Installing HTTP and API clients...'
          pip install --no-deps httpx==0.27.0
          pip install --no-deps requests==2.31.0
          pip install --no-deps openai==1.51.0
          pip install --no-deps anthropic==0.26.2

          # Step 4: Computer vision with exact versions
          echo 'Step 4: Installing computer vision...'
          pip install --no-deps opencv-python-headless==4.8.0.76
          pip install --no-deps Pillow==10.2.0
          pip install --no-deps scikit-image==0.21.0
          pip install --no-deps imageio==2.31.6

          # Step 5: LlamaIndex with ACTUALLY compatible versions (fixed conflicts)
          echo 'Step 5: Installing LlamaIndex ecosystem with verified compatible versions...'
          pip install --no-deps llama-index-core==0.11.20 || echo 'llama-index-core installation failed'
          echo \"Installing llama-index...\" >> /tmp/pip-install.log
          echo 'Attempting llama-index installation...'
          if pip install --no-deps llama-index==0.11.20 2>&1 | tee -a /tmp/pip-install.log; then
            echo '‚úÖ llama-index installed successfully with --no-deps'
          elif pip install llama-index==0.11.20 2>&1 | tee -a /tmp/pip-install.log; then
            echo '‚úÖ llama-index installed successfully with dependencies'
          elif pip install --force-reinstall llama-index==0.11.20 2>&1 | tee -a /tmp/pip-install.log; then
            echo '‚úÖ llama-index installed successfully with force-reinstall'
          else
            echo '‚ùå llama-index installation failed completely' | tee -a /tmp/pip-install.log
            echo 'Checking if llama-index-core is available...'
            python -c 'import llama_index_core; print(\"llama-index-core available:\", llama_index_core.__version__)' || echo 'llama-index-core not available'
          fi
          pip install --no-deps llama-index-llms-openai==0.1.29
          pip install --no-deps llama-index-embeddings-openai==0.1.11
          pip install --no-deps llama-index-embeddings-clip==0.1.5
          pip install --no-deps llama-index-multi-modal-llms-openai==0.1.9
          pip install --no-deps llama-index-multi-modal-llms-anthropic==0.1.4
          pip install --no-deps llama-index-agent-openai==0.2.9
          pip install --no-deps llama-index-program-openai==0.1.6
          pip install --no-deps llama-index-question-gen-openai==0.1.3
          pip install --no-deps llama-index-vector-stores-supabase==0.1.4
          pip install --no-deps llama-index-readers-file==0.1.12
          pip install --no-deps llama-index-cli==0.1.13

          # Fix pypdf version conflict
          pip install --no-deps pypdf==4.3.1

          # Step 6: Web framework and remaining packages
          echo 'Step 6: Installing web framework and remaining packages...'
          pip install --no-deps fastapi==0.115.0
          pip install --no-deps starlette==0.40.0
          pip install --no-deps anyio==3.7.1
          pip install --no-deps uvicorn==0.24.0
          # Try to install PyMuPDF with multiple fallback strategies
          echo \"Installing PyMuPDF...\" >> /tmp/pip-install.log
          echo 'Attempting PyMuPDF installation with bundled libraries...'

          # First try: Use older version that might have better compatibility
          if pip install --no-deps PyMuPDF==1.23.26 2>&1 | tee -a /tmp/pip-install.log; then
            echo '‚úÖ PyMuPDF 1.23.26 installed successfully'
          elif pip install PyMuPDF==1.23.26 2>&1 | tee -a /tmp/pip-install.log; then
            echo '‚úÖ PyMuPDF 1.23.26 installed with dependencies'
          elif pip install --force-reinstall --no-cache-dir PyMuPDF==1.23.26 2>&1 | tee -a /tmp/pip-install.log; then
            echo '‚úÖ PyMuPDF 1.23.26 force-reinstalled'
          elif pip install --no-deps PyMuPDF==1.22.5 2>&1 | tee -a /tmp/pip-install.log; then
            echo '‚úÖ PyMuPDF 1.22.5 installed (older stable version)'
          else
            echo '‚ùå All PyMuPDF versions failed' | tee -a /tmp/pip-install.log
            echo 'Trying alternative approaches...'

            # Try installing from wheel with specific platform
            echo 'Trying platform-specific wheel...'
            pip install --no-deps --only-binary=all PyMuPDF==1.23.26 2>&1 | tee -a /tmp/pip-install.log || echo 'Platform wheel failed'

            # Try different package name
            echo 'Trying pymupdf package name...'
            pip install pymupdf==1.23.26 2>&1 | tee -a /tmp/pip-install.log || echo 'pymupdf package failed'

            # Try building from source as last resort
            echo 'Trying build from source...'
            pip install --no-binary PyMuPDF PyMuPDF==1.23.26 2>&1 | tee -a /tmp/pip-install.log || echo 'Source build failed'
          fi

          # Install pymupdf4llm with comprehensive error handling
          echo \"Installing pymupdf4llm...\" >> /tmp/pip-install.log
          echo 'Attempting pymupdf4llm installation...'

          # First ensure PyMuPDF is working
          echo 'Testing PyMuPDF before installing pymupdf4llm...'
          if python -c 'import fitz; print(\"PyMuPDF test:\", fitz.__version__)' 2>/dev/null; then
            echo '‚úÖ PyMuPDF is working, proceeding with pymupdf4llm...'

            if pip install --no-deps pymupdf4llm==0.0.12 2>&1 | tee -a /tmp/pip-install.log; then
              echo '‚úÖ pymupdf4llm installed successfully with --no-deps'
            elif pip install pymupdf4llm==0.0.12 2>&1 | tee -a /tmp/pip-install.log; then
              echo '‚úÖ pymupdf4llm installed successfully with dependencies'
            elif pip install --force-reinstall pymupdf4llm==0.0.12 2>&1 | tee -a /tmp/pip-install.log; then
              echo '‚úÖ pymupdf4llm installed successfully with force-reinstall'
            else
              echo '‚ùå pymupdf4llm installation failed - trying older version...'
              pip install pymupdf4llm==0.0.6 2>&1 | tee -a /tmp/pip-install.log || echo 'All pymupdf4llm versions failed'
            fi
          else
            echo '‚ùå PyMuPDF not working - skipping pymupdf4llm installation'
            echo 'PyMuPDF must be fixed first before pymupdf4llm can work'
          fi
          pip install --no-deps supabase==2.3.0
          pip install --no-deps postgrest==0.13.0
          pip install --no-deps gotrue==2.9.1
          pip install --no-deps storage3==0.7.7
          pip install --no-deps supafunc==0.3.3
          pip install --no-deps realtime==1.0.6

          # Step 7: Install missing dependencies that --no-deps skipped (FIXED VERSIONS)
          echo 'Step 7: Installing essential dependencies with compatible versions...'
          pip install pydantic==2.8.0
          pip install pydantic-settings==2.1.0
          pip install python-dotenv==1.0.1
          pip install python-multipart==0.0.6
          pip install python-dateutil==2.8.2
          pip install typing-extensions==4.11.0
          pip install PyJWT==2.10.1
          pip install cryptography==41.0.7
          pip install email-validator==2.1.0
          pip install aiofiles==23.2.1
          pip install bcrypt==4.1.2
          pip install psutil==5.9.6
          pip install tenacity==8.5.0
          pip install matplotlib==3.7.5
          pip install nltk==3.9.1
          pip install easyocr==1.7.0
          pip install pytesseract==0.3.10
          pip install scikit-learn==1.3.2
          pip install transformers==4.41.0
          pip install sentence-transformers==3.0.0
          pip install asyncio-mqtt==0.13.0
          pip install aiohttp==3.9.3

          echo 'All dependencies installed with exact versions - no conflicts!'
          "

      # 4.3. Verify package installations
      - name: ‚úÖ Verify package installations
        run: |
          ssh -o StrictHostKeyChecking=no root@104.248.68.3 "
          cd /var/www/mivaa-pdf-extractor
          source .venv/bin/activate
          export LD_LIBRARY_PATH=\"/usr/lib/x86_64-linux-gnu:\$LD_LIBRARY_PATH\"

          # --- Comprehensive Package Verification ---
          echo 'Verifying all critical packages from requirements.txt...'
          echo '================================================================'

          # Verify critical packages
          python -c 'import fastapi; print(\"FastAPI: OK\")'
          python -c 'import uvicorn; print(\"Uvicorn: OK\")'
          python -c 'import cv2; print(\"OpenCV: OK\")'
          # Test PyMuPDF with detailed error handling
          echo 'Testing PyMuPDF installation...'
          python -c 'import sys; import fitz; print(\"PyMuPDF (fitz): OK - Version\", fitz.version[0]); print(\"PyMuPDF library path:\", fitz.__file__)' 2>/dev/null || {
            echo 'PyMuPDF (fitz): FAILED'
            python -c 'import fitz' 2>&1 | head -3 || echo 'Import completely failed'
          }

          python -c 'import pymupdf4llm; print(\"PyMuPDF4LLM: OK\"); print(\"PyMuPDF4LLM path:\", pymupdf4llm.__file__)' 2>/dev/null || {
            echo 'PyMuPDF4LLM: FAILED'
            python -c 'import pymupdf4llm' 2>&1 | head -3 || echo 'Import completely failed'
          }
          python -c 'import llama_index; print(\"LlamaIndex: OK\")' || echo 'LlamaIndex: FAILED - Check installation'
          python -c 'import supabase; print(\"Supabase: OK\")'
          python -c 'import numpy; print(\"NumPy: OK\")'
          python -c 'import pandas; print(\"Pandas: OK\")'
          python -c 'import PIL; print(\"Pillow: OK\")'
          python -c 'import pydantic; print(\"Pydantic: OK\")'
          python -c 'import requests; print(\"Requests: OK\")'

          echo 'ALL CRITICAL PACKAGES VERIFIED!'

          # Debug: Check if problematic packages are actually installed
          echo 'Debugging package installations...'
          echo 'Checking pip list for problematic packages:'
          pip list | grep -i pymupdf || echo 'No PyMuPDF packages found'
          pip list | grep -i llama || echo 'No llama packages found'

          echo 'Testing direct imports:'
          python -c 'import pymupdf4llm; print(\"pymupdf4llm import: SUCCESS\")' 2>/dev/null || echo 'pymupdf4llm import: FAILED'
          python -c 'import llama_index; print(\"llama_index import: SUCCESS\")' 2>/dev/null || echo 'llama_index import: FAILED'

          # Debug: Check system libraries
          echo 'Checking system MuPDF libraries...'
          find /usr -name '*mupdf*' 2>/dev/null | head -10 || echo 'No MuPDF libraries found in /usr'
          ldconfig -p | grep mupdf || echo 'No MuPDF libraries in ldconfig cache'

          # Check what libmupdf files are available
          echo 'Checking for libmupdf.so files...'
          find /usr -name 'libmupdf.so*' 2>/dev/null || echo 'No libmupdf.so files found'
          ls -la /usr/lib/x86_64-linux-gnu/libmupdf* 2>/dev/null || echo 'No libmupdf in standard lib directory'

          # Check if we can create a symlink to fix the version issue
          if [ -f /usr/lib/x86_64-linux-gnu/libmupdf.so ]; then
            echo 'Found libmupdf.so, creating version-specific symlink...'
            ln -sf /usr/lib/x86_64-linux-gnu/libmupdf.so /usr/lib/x86_64-linux-gnu/libmupdf.so.24.1 2>/dev/null && echo 'Symlink created' || echo 'Symlink failed'
          fi

          # Generate actual package status for GitHub summary
          echo 'Generating package status report...'

          # Create simple package status check
          echo '| Package | Category | Description | Status | Version |' > package_status_report.txt
          echo '|---------|----------|-------------|--------|---------|' >> package_status_report.txt

          # Check each critical package individually
          python -c 'import fastapi; print(f\"| **fastapi** | Web Framework | FastAPI web framework | üü¢ Installed | {fastapi.__version__} |\")' >> package_status_report.txt 2>/dev/null || echo '| **fastapi** | Web Framework | FastAPI web framework | üî¥ Missing | N/A |' >> package_status_report.txt
          python -c 'import uvicorn; print(f\"| **uvicorn** | Server | ASGI server | üü¢ Installed | {uvicorn.__version__} |\")' >> package_status_report.txt 2>/dev/null || echo '| **uvicorn** | Server | ASGI server | üî¥ Missing | N/A |' >> package_status_report.txt
          python -c 'import cv2; print(f\"| **opencv-python-headless** | Computer Vision | Image processing | üü¢ Installed | {cv2.__version__} |\")' >> package_status_report.txt 2>/dev/null || echo '| **opencv-python-headless** | Computer Vision | Image processing | üî¥ Missing | N/A |' >> package_status_report.txt
          # Check pymupdf4llm with detailed error handling
          if python -c 'import pymupdf4llm; print(f\"| **pymupdf4llm** | PDF Processing | PDF processing for LLM | üü¢ Installed | {pymupdf4llm.__version__} |\")' >> package_status_report.txt 2>/dev/null; then
            echo 'pymupdf4llm status: OK'
          else
            echo '| **pymupdf4llm** | PDF Processing | PDF processing for LLM | üî¥ Missing | N/A |' >> package_status_report.txt
            echo 'pymupdf4llm status: FAILED'
            python -c 'import pymupdf4llm' 2>&1 | head -3 || echo 'Import test failed'
          fi
          python -c 'import supabase; print(f\"| **supabase** | Database | Database client | üü¢ Installed | {supabase.__version__} |\")' >> package_status_report.txt 2>/dev/null || echo '| **supabase** | Database | Database client | üî¥ Missing | N/A |' >> package_status_report.txt
          python -c 'import numpy; print(f\"| **numpy** | Computing | Numerical computing | üü¢ Installed | {numpy.__version__} |\")' >> package_status_report.txt 2>/dev/null || echo '| **numpy** | Computing | Numerical computing | üî¥ Missing | N/A |' >> package_status_report.txt
          python -c 'import pandas; print(f\"| **pandas** | Data | Data manipulation | üü¢ Installed | {pandas.__version__} |\")' >> package_status_report.txt 2>/dev/null || echo '| **pandas** | Data | Data manipulation | üî¥ Missing | N/A |' >> package_status_report.txt
          python -c 'import torch; print(f\"| **torch** | AI/ML | PyTorch deep learning | üü¢ Installed | {torch.__version__} |\")' >> package_status_report.txt 2>/dev/null || echo '| **torch** | AI/ML | PyTorch deep learning | üî¥ Missing | N/A |' >> package_status_report.txt
          python -c 'import openai; print(f\"| **openai** | AI/ML | OpenAI API client | üü¢ Installed | {openai.__version__} |\")' >> package_status_report.txt 2>/dev/null || echo '| **openai** | AI/ML | OpenAI API client | üî¥ Missing | N/A |' >> package_status_report.txt
          python -c 'import anthropic; print(f\"| **anthropic** | AI/ML | Anthropic API client | üü¢ Installed | {anthropic.__version__} |\")' >> package_status_report.txt 2>/dev/null || echo '| **anthropic** | AI/ML | Anthropic API client | üî¥ Missing | N/A |' >> package_status_report.txt
          # Check llama-index with detailed error handling
          if python -c 'import llama_index; print(f\"| **llama-index** | AI/ML | LLM framework | üü¢ Installed | {llama_index.__version__} |\")' >> package_status_report.txt 2>/dev/null; then
            echo 'llama-index status: OK'
          else
            echo '| **llama-index** | AI/ML | LLM framework | üî¥ Missing | N/A |' >> package_status_report.txt
            echo 'llama-index status: FAILED'
            python -c 'import llama_index' 2>&1 | head -3 || echo 'Import test failed'
          fi

          echo '' >> package_status_report.txt
          echo 'Package status report generated successfully'

          # Ensure package status report exists even if some packages failed
          if [ ! -f package_status_report.txt ]; then
            echo '| **Status** | Error | Package status report creation failed | üî¥ Failed | N/A |' > package_status_report.txt
          fi
          "

      # 4.5. Update Package Status in Summary
      - name: üì¶ Update Package Installation Status
        if: always()  # Run even if previous steps failed
        run: |
          echo "üì¶ Updating package installation status in summary..."

          # Get the actual package status and update the summary
          PACKAGE_STATUS=$(ssh -o StrictHostKeyChecking=no root@104.248.68.3 "
          cd /var/www/mivaa-pdf-extractor
          if [ -f .venv/bin/activate ]; then
            source .venv/bin/activate
            cat package_status_report.txt 2>/dev/null || echo '| **Status** | Error | Package status report not found | üî¥ Failed | N/A |'
          else
            echo '| **Status** | Error | Virtual environment not found | üî¥ Failed | N/A |'
          fi
          " 2>/dev/null || echo "| **Status** | Error | Could not connect to server | üî¥ Failed | N/A |")

          # Create a new summary file with updated package status
          cat > updated_summary.md << 'SUMMARY_EOF'

          ## üì¶ Package Installation Status - UPDATED

          SUMMARY_EOF

          echo "$PACKAGE_STATUS" >> updated_summary.md

          # Append the updated status to the GitHub summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          cat updated_summary.md >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "‚úÖ Package status updated in deployment summary"

      # 4.5.1. Fallback Package Status (Always runs)
      - name: üì¶ Fallback Package Status Check
        if: always()  # Always run this step
        run: |
          echo "üì¶ Running fallback package status check..."

          # Try to get basic status information
          BASIC_STATUS=$(ssh -o StrictHostKeyChecking=no root@104.248.68.3 "
          echo '=== Basic System Status ==='
          echo 'Server: Online ‚úÖ'
          echo 'SSH Connection: Working ‚úÖ'
          if [ -d '/var/www/mivaa-pdf-extractor' ]; then
            echo 'App Directory: Exists ‚úÖ'
            cd /var/www/mivaa-pdf-extractor
            if [ -d '.venv' ]; then
              echo 'Virtual Environment: Exists ‚úÖ'
              if [ -f '.venv/bin/activate' ]; then
                echo 'Virtual Environment: Functional ‚úÖ'
                source .venv/bin/activate
                python --version 2>/dev/null && echo 'Python: Working ‚úÖ' || echo 'Python: Failed ‚ùå'
              else
                echo 'Virtual Environment: Broken ‚ùå'
              fi
            else
              echo 'Virtual Environment: Missing ‚ùå'
            fi
          else
            echo 'App Directory: Missing ‚ùå'
          fi
          " 2>/dev/null || echo "SSH Connection: Failed ‚ùå")

          echo "üìä Basic Status Information:"
          echo "$BASIC_STATUS"

          # Add to summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìä Basic System Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$BASIC_STATUS" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      # 4.6. Create/Update systemd service file
      - name: üîß Create/Update systemd service file
        run: |
          echo "üîß Creating/updating systemd service file..."
          ssh -o StrictHostKeyChecking=no root@104.248.68.3 'sudo tee /etc/systemd/system/mivaa-pdf-extractor.service > /dev/null' << 'SERVICE_EOF'
          [Unit]
          Description=Mivaa PDF Extractor FastAPI service
          After=network.target

          [Service]
          Type=simple
          User=root
          WorkingDirectory=/var/www/mivaa-pdf-extractor
          Environment=PATH=/root/.pyenv/shims:/root/.pyenv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
          Environment=PYTHONPATH=/var/www/mivaa-pdf-extractor
          ExecStart=/var/www/mivaa-pdf-extractor/.venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000
          Restart=always
          RestartSec=3
          StandardOutput=journal
          StandardError=journal

          [Install]
          WantedBy=multi-user.target
          SERVICE_EOF

      # 4.6. Restart service
      - name: üîÑ Restart service
        run: |
          echo "üîÑ Reloading systemd and restarting service..."
          ssh -o StrictHostKeyChecking=no root@104.248.68.3 "
          # Reload systemd and enable service
          sudo systemctl daemon-reload
          sudo systemctl enable mivaa-pdf-extractor

          # Restart the FastAPI service
          sudo systemctl restart mivaa-pdf-extractor

          # Check service status
          sudo systemctl status mivaa-pdf-extractor --no-pager
          "

      # 6. Health Check & Diagnostics
      - name: üè• Health Check & Diagnostics
        run: |
          echo "üè• Performing comprehensive health checks..."
          echo "=========================================="

          # Wait a moment for service to fully start
          sleep 10

          # Health check with detailed response
          echo "üîç Checking health endpoint..."
          HEALTH_URL="https://v1api.materialshub.gr/health"

          # Perform health check and capture response
          HTTP_STATUS=$(curl -s -o /tmp/health_response.json -w "%{http_code}" "$HEALTH_URL" || echo "000")

          echo "üìä Health Check Results:"
          echo "  ‚Ä¢ URL: $HEALTH_URL"
          echo "  ‚Ä¢ HTTP Status: $HTTP_STATUS"

          # Capture service logs and system information for debugging
          echo "üìã Capturing service logs and system information..."
          SERVICE_LOGS=$(ssh -o StrictHostKeyChecking=no root@104.248.68.3 "
          echo '=== MIVAA PDF Extractor Service Logs ==='
          echo 'Last 50 log entries:'
          echo ''
          journalctl -u mivaa-pdf-extractor --no-pager -n 50 --since='1 hour ago' 2>/dev/null || echo 'Service logs not available'
          echo ''
          echo '=== Service Status ==='
          systemctl status mivaa-pdf-extractor --no-pager --lines=20 2>/dev/null || echo 'Service status not available'
          echo ''
          echo '=== Live Service Logs (Last 10 seconds) ==='
          timeout 10s journalctl -u mivaa-pdf-extractor -f --no-pager 2>/dev/null || echo 'Live logs not available'
          echo ''
          echo '=== Recent System Logs (Errors) ==='
          journalctl --no-pager -p err -n 10 --since='1 hour ago' 2>/dev/null || echo 'System error logs not available'
          echo ''
          echo '=== Disk Space ==='
          df -h /var/www/mivaa-pdf-extractor 2>/dev/null || echo 'Disk space info not available'
          echo ''
          echo '=== Memory Usage ==='
          free -h 2>/dev/null || echo 'Memory info not available'
          " 2>/dev/null || echo "Could not retrieve service logs and system information")

          # Package status is already updated in the main status section above



          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üè• Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|---------|" >> $GITHUB_STEP_SUMMARY

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "‚úÖ Health check PASSED - Service is healthy!"
            echo "üìÑ Response:"
            cat /tmp/health_response.json 2>/dev/null || echo "  (No response body)"

            # Add success to summary
            echo "| **üè• Health Endpoint** | ‚úÖ HEALTHY | HTTP 200 - Service responding correctly |" >> $GITHUB_STEP_SUMMARY
            echo "| **üìä Response Time** | ‚úÖ GOOD | < 5 seconds |" >> $GITHUB_STEP_SUMMARY

            # Test additional endpoints
            echo ""
            echo "üîç Testing additional endpoints..."

            # Test API docs
            DOCS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://v1api.materialshub.gr/docs" || echo "000")
            echo "  ‚Ä¢ API Docs (/docs): $DOCS_STATUS"

            # Test OpenAPI schema
            OPENAPI_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://v1api.materialshub.gr/openapi.json" || echo "000")
            echo "  ‚Ä¢ OpenAPI Schema (/openapi.json): $OPENAPI_STATUS"

            # Add endpoint tests to summary
            if [ "$DOCS_STATUS" = "200" ]; then
              echo "| **üìö API Documentation** | ‚úÖ AVAILABLE | HTTP 200 |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| **üìö API Documentation** | ‚ö†Ô∏è ISSUE | HTTP $DOCS_STATUS |" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "$OPENAPI_STATUS" = "200" ]; then
              echo "| **üìã OpenAPI Schema** | ‚úÖ AVAILABLE | HTTP 200 |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| **üìã OpenAPI Schema** | ‚ö†Ô∏è ISSUE | HTTP $OPENAPI_STATUS |" >> $GITHUB_STEP_SUMMARY
            fi

          else
            echo "‚ùå Health check FAILED - Service has issues!"
            echo "üö® HTTP Status: $HTTP_STATUS"
            echo "üìÑ Response (if any):"
            cat /tmp/health_response.json 2>/dev/null || echo "  (No response received)"

            # Add failure to summary
            echo "| **üè• Health Endpoint** | ‚ùå UNHEALTHY | HTTP $HTTP_STATUS - Service not responding correctly |" >> $GITHUB_STEP_SUMMARY
            echo "| **üö® Issue Detected** | ‚ö†Ô∏è CRITICAL | Automatic diagnostics initiated |" >> $GITHUB_STEP_SUMMARY

            echo ""
            echo "üîß Initiating automatic diagnostics..."
            echo "====================================="

            # SSH into server and gather diagnostics
            ssh -o StrictHostKeyChecking=no root@104.248.68.3 '
            echo "üîç AUTOMATIC DIAGNOSTICS - Service Health Check Failed"
            echo "======================================================"
            echo ""

            echo "üìä System Status:"
            echo "  ‚Ä¢ Date: $(date)"
            echo "  ‚Ä¢ Uptime: $(uptime)"
            echo "  ‚Ä¢ Load: $(cat /proc/loadavg)"
            echo "  ‚Ä¢ Memory: $(free -h | grep Mem)"
            echo "  ‚Ä¢ Disk: $(df -h / | tail -1)"
            echo ""

            echo "üîß Service Status:"
            sudo systemctl status mivaa-pdf-extractor --no-pager --lines=10
            echo ""

            echo "üìã Service Configuration:"
            echo "  ‚Ä¢ Service file: /etc/systemd/system/mivaa-pdf-extractor.service"
            if [ -f "/etc/systemd/system/mivaa-pdf-extractor.service" ]; then
              echo "  ‚Ä¢ Service file exists: ‚úÖ"
              echo "  ‚Ä¢ Working Directory: $(grep WorkingDirectory /etc/systemd/system/mivaa-pdf-extractor.service || echo '\''Not set'\'')"
              echo "  ‚Ä¢ ExecStart: $(grep ExecStart /etc/systemd/system/mivaa-pdf-extractor.service || echo '\''Not set'\'')"
              echo "  ‚Ä¢ Environment: $(grep Environment /etc/systemd/system/mivaa-pdf-extractor.service || echo '\''Not set'\'')"
            else
              echo "  ‚Ä¢ Service file exists: ‚ùå"
            fi
            echo ""

            echo "üìã Recent Service Logs (Last 50 lines):"
            echo "========================================"
            sudo journalctl -u mivaa-pdf-extractor --no-pager --lines=50 --since "10 minutes ago"
            echo ""

            echo "üåê Network & Port Status:"
            echo "  ‚Ä¢ Port 8000 listening: $(ss -tlnp | grep :8000 || echo '\''NOT LISTENING'\'')"
            echo "  ‚Ä¢ Process on port 8000: $(lsof -i :8000 || echo '\''NO PROCESS'\'')"
            echo ""

            echo "üìÅ Application Directory:"
            echo "  ‚Ä¢ Directory exists: $([ -d /var/www/mivaa-pdf-extractor ] && echo '\''YES'\'' || echo '\''NO'\'')"
            echo "  ‚Ä¢ Recent files: $(ls -la /var/www/mivaa-pdf-extractor/ | head -10)"
            echo ""

            echo "üêç Python Environment:"
            cd /var/www/mivaa-pdf-extractor 2>/dev/null || echo "Cannot access app directory"
            if [ -f ".venv/bin/activate" ]; then
              source .venv/bin/activate
              echo "  ‚Ä¢ Python version: $(python --version)"
              echo "  ‚Ä¢ FastAPI installed: $(python -c '\''import fastapi; print(fastapi.__version__)'\'' 2>/dev/null || echo '\''NOT FOUND'\'')"
              echo "  ‚Ä¢ Virtual env active: $VIRTUAL_ENV"
            else
              echo "  ‚Ä¢ Virtual environment: NOT FOUND"
            fi
            echo ""

            echo "üîÑ Attempting Service Restart:"
            echo "=============================="
            sudo systemctl restart mivaa-pdf-extractor
            sleep 5
            echo "  ‚Ä¢ Restart completed"
            echo "  ‚Ä¢ New status: $(sudo systemctl is-active mivaa-pdf-extractor)"
            echo ""

            echo "üìã Post-Restart Logs (Last 20 lines):"
            echo "====================================="
            sudo journalctl -u mivaa-pdf-extractor --no-pager --lines=20 --since "1 minute ago"
            '

            echo ""
            echo "üîÑ Re-testing health endpoint after diagnostics..."
            sleep 10

            # Re-test health endpoint
            RETEST_STATUS=$(curl -s -o /tmp/health_retest.json -w "%{http_code}" "https://v1api.materialshub.gr/health" || echo "000")
            echo "üîç Re-test Results:"
            echo "  ‚Ä¢ HTTP Status: $RETEST_STATUS"

            if [ "$RETEST_STATUS" = "200" ]; then
              echo "‚úÖ Service recovered after restart!"
              echo "| **üîÑ Recovery Status** | ‚úÖ RECOVERED | Service healthy after automatic restart |" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå Service still unhealthy after restart"
              echo "üö® Manual intervention may be required"
              echo "| **üîÑ Recovery Status** | ‚ùå FAILED | Manual intervention required |" >> $GITHUB_STEP_SUMMARY
              echo "| **üìû Next Steps** | üîß MANUAL | Check logs above and contact system administrator |" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîç Health Check Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Endpoint**: \`$HEALTH_URL\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Response Code**: \`$HTTP_STATUS\`" >> $GITHUB_STEP_SUMMARY
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "- **‚ö†Ô∏è Diagnostics**: Automatic diagnostics executed (see logs above)" >> $GITHUB_STEP_SUMMARY
            echo "- **üîÑ Recovery**: Automatic restart attempted" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get FINAL current status of all endpoints for accurate Service Endpoints table
          echo "üîç Getting final current status of all endpoints for Service Endpoints table..."
          FINAL_HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://v1api.materialshub.gr/health" --connect-timeout 10 --max-time 30 || echo "000")
          FINAL_DOCS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://v1api.materialshub.gr/docs" --connect-timeout 10 --max-time 30 || echo "000")
          FINAL_REDOC_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://v1api.materialshub.gr/redoc" --connect-timeout 10 --max-time 30 || echo "000")
          FINAL_OPENAPI_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://v1api.materialshub.gr/openapi.json" --connect-timeout 10 --max-time 30 || echo "000")

          echo "üìä Final Status Summary:"
          echo "  ‚Ä¢ Health: $FINAL_HEALTH_STATUS"
          echo "  ‚Ä¢ Docs: $FINAL_DOCS_STATUS"
          echo "  ‚Ä¢ ReDoc: $FINAL_REDOC_STATUS"
          echo "  ‚Ä¢ OpenAPI: $FINAL_OPENAPI_STATUS"

          # Add Service Endpoints table with FINAL current status
          echo "## üåê Service Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|--------|" >> $GITHUB_STEP_SUMMARY

          # Health endpoint status
          if [ "$FINAL_HEALTH_STATUS" = "200" ]; then
            echo "| **üè• Health Check** | [https://v1api.materialshub.gr/health](https://v1api.materialshub.gr/health) | üü¢ Available (HTTP 200) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **üè• Health Check** | [https://v1api.materialshub.gr/health](https://v1api.materialshub.gr/health) | üî¥ Unavailable (HTTP $FINAL_HEALTH_STATUS) |" >> $GITHUB_STEP_SUMMARY
          fi

          # API docs status
          if [ "$FINAL_DOCS_STATUS" = "200" ]; then
            echo "| **üìö API Documentation** | [https://v1api.materialshub.gr/docs](https://v1api.materialshub.gr/docs) | üü¢ Available (HTTP 200) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **üìö API Documentation** | [https://v1api.materialshub.gr/docs](https://v1api.materialshub.gr/docs) | üî¥ Unavailable (HTTP $FINAL_DOCS_STATUS) |" >> $GITHUB_STEP_SUMMARY
          fi

          # OpenAPI schema status
          if [ "$FINAL_OPENAPI_STATUS" = "200" ]; then
            echo "| **üìã OpenAPI Schema** | [https://v1api.materialshub.gr/openapi.json](https://v1api.materialshub.gr/openapi.json) | üü¢ Available (HTTP 200) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **üìã OpenAPI Schema** | [https://v1api.materialshub.gr/openapi.json](https://v1api.materialshub.gr/openapi.json) | üî¥ Unavailable (HTTP $FINAL_OPENAPI_STATUS) |" >> $GITHUB_STEP_SUMMARY
          fi

          # ReDoc endpoint status
          if [ "$FINAL_REDOC_STATUS" = "200" ]; then
            echo "| **üìñ ReDoc** | [https://v1api.materialshub.gr/redoc](https://v1api.materialshub.gr/redoc) | üü¢ Available (HTTP 200) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **üìñ ReDoc** | [https://v1api.materialshub.gr/redoc](https://v1api.materialshub.gr/redoc) | üî¥ Unavailable (HTTP $FINAL_REDOC_STATUS) |" >> $GITHUB_STEP_SUMMARY
          fi

          # API endpoints depend on health status
          if [ "$FINAL_HEALTH_STATUS" = "200" ]; then
            echo "| **üìÑ PDF Processing** | [https://v1api.materialshub.gr/api/v1/pdf/](https://v1api.materialshub.gr/api/v1/pdf/) | üü¢ Available (Depends on Health) |" >> $GITHUB_STEP_SUMMARY
            echo "| **ü§ñ AI Analysis** | [https://v1api.materialshub.gr/api/v1/ai/](https://v1api.materialshub.gr/api/v1/ai/) | üü¢ Available (Depends on Health) |" >> $GITHUB_STEP_SUMMARY
            echo "| **üîç Vector Search** | [https://v1api.materialshub.gr/api/v1/search/](https://v1api.materialshub.gr/api/v1/search/) | üü¢ Available (Depends on Health) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **üìÑ PDF Processing** | [https://v1api.materialshub.gr/api/v1/pdf/](https://v1api.materialshub.gr/api/v1/pdf/) | üî¥ Unavailable (Service Down) |" >> $GITHUB_STEP_SUMMARY
            echo "| **ü§ñ AI Analysis** | [https://v1api.materialshub.gr/api/v1/ai/](https://v1api.materialshub.gr/api/v1/ai/) | üî¥ Unavailable (Service Down) |" >> $GITHUB_STEP_SUMMARY
            echo "| **üîç Vector Search** | [https://v1api.materialshub.gr/api/v1/search/](https://v1api.materialshub.gr/api/v1/search/) | üî¥ Unavailable (Service Down) |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      # 7. Post-Deployment Summary
      - name: üìä Final Deployment Summary
        run: |
          echo ""
          echo "üéâ MIVAA PDF Extractor Deployment Complete!"
          echo "=========================================="
          echo ""
          echo "‚úÖ Deployment Status: SUCCESS"
          echo "üìÖ Completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "‚è±Ô∏è Duration: Approximately 2-3 minutes"

          # Add deployment results to summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üéâ Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| **‚úÖ Status** | SUCCESS |" >> $GITHUB_STEP_SUMMARY
          echo "| **üìÖ Completed** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| **‚è±Ô∏è Duration** | ~2-3 minutes |" >> $GITHUB_STEP_SUMMARY
          echo "| **üîÑ Service Status** | Active and running |" >> $GITHUB_STEP_SUMMARY
          echo "| **‚öôÔ∏è Process Manager** | systemd |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo ""
          echo "üåê Service Information:"
          echo "  ‚Ä¢ Server: 104.248.68.3"
          echo "  ‚Ä¢ Service: mivaa-pdf-extractor.service"
          echo "  ‚Ä¢ Status: Active and running"
          echo "  ‚Ä¢ Process Manager: systemd"
          echo ""
          echo "üîó API Endpoints Available:"
          echo "  ‚Ä¢ Health Check: https://v1api.materialshub.gr/health"
          echo "  ‚Ä¢ API Documentation: https://v1api.materialshub.gr/docs"
          echo "  ‚Ä¢ OpenAPI Schema: https://v1api.materialshub.gr/openapi.json"
          echo "  ‚Ä¢ PDF Processing: https://v1api.materialshub.gr/api/v1/pdf/*"
          echo "  ‚Ä¢ AI Analysis: https://v1api.materialshub.gr/api/v1/ai/*"
          echo "  ‚Ä¢ Vector Search: https://v1api.materialshub.gr/api/v1/search/*"


          echo "" >> $GITHUB_STEP_SUMMARY
          echo ""
          echo "üß™ Quick Health Check Commands:"
          echo "  curl https://v1api.materialshub.gr/health"
          echo "  curl https://v1api.materialshub.gr/docs"
          echo ""
          echo "üìã Deployment Verification:"
          echo "  ‚Ä¢ ‚úÖ Code updated to latest commit"
          echo "  ‚Ä¢ ‚úÖ Python environment refreshed"
          echo "  ‚Ä¢ ‚úÖ Dependencies synchronized with uv"
          echo "  ‚Ä¢ ‚úÖ Critical imports verified (FastAPI, PyMuPDF, pymupdf4llm)"
          echo "  ‚Ä¢ ‚úÖ Service restarted successfully"
          echo "  ‚Ä¢ ‚úÖ systemd reports service as active"
          echo ""
          echo "üîß Troubleshooting (if needed):"
          echo "  ‚Ä¢ SSH: ssh root@104.248.68.3"
          echo "  ‚Ä¢ Logs: sudo journalctl -u mivaa-pdf-extractor -f"
          echo "  ‚Ä¢ Status: sudo systemctl status mivaa-pdf-extractor"
          echo "  ‚Ä¢ Restart: sudo systemctl restart mivaa-pdf-extractor"
          echo "  ‚Ä¢ App Directory: cd /var/www/mivaa-pdf-extractor"
          echo ""
          echo "üìà Next Steps:"
          echo "  1. Verify API endpoints are responding"
          echo "  2. Test PDF processing functionality"
          echo "  3. Monitor application logs for any issues"
          echo "  4. Update any dependent services if needed"
          echo ""
          echo "üéØ Deployment completed successfully! üöÄ"

          # Add quick actions to summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üöÄ Quick Actions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- üåê [**Access Application**](https://v1api.materialshub.gr)" >> $GITHUB_STEP_SUMMARY
          echo "- üè• [**Check Health**](https://v1api.materialshub.gr/health)" >> $GITHUB_STEP_SUMMARY
          echo "- üìö [**View API Docs**](https://v1api.materialshub.gr/docs)" >> $GITHUB_STEP_SUMMARY
          echo "- üìñ [**View ReDoc**](https://v1api.materialshub.gr/redoc)" >> $GITHUB_STEP_SUMMARY
          echo "- üîç [**View Commit**](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Add Errors & Logs section (collapsible)
          echo "## üìã Errors & Logs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>üîç <strong>Click to view service logs and debugging information</strong></summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Service Status & Logs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$SERVICE_LOGS" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üêõ Debugging Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Service Name**: mivaa-pdf-extractor" >> $GITHUB_STEP_SUMMARY
          echo "- **Log Command**: \`sudo journalctl -u mivaa-pdf-extractor -f\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Service Status**: \`sudo systemctl status mivaa-pdf-extractor\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Service Restart**: \`sudo systemctl restart mivaa-pdf-extractor\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Log Location**: \`/var/log/mivaa-pdf-extractor/\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Add troubleshooting section
          echo "## üîß Troubleshooting" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Health Check" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "curl https://v1api.materialshub.gr/health" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SSH Access" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "ssh root@104.248.68.3" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Service Management" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "sudo systemctl status mivaa-pdf-extractor" >> $GITHUB_STEP_SUMMARY
          echo "sudo systemctl restart mivaa-pdf-extractor" >> $GITHUB_STEP_SUMMARY
          echo "sudo journalctl -u mivaa-pdf-extractor -f" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Add footer
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "üöÄ **MIVAA Default Deployment Pipeline** | üïê Generated: $(date) | üìã ID: \`${{ github.run_id }}\`" >> $GITHUB_STEP_SUMMARY
