name: ğŸš€ MIVAA Deployment (Default)

on:
  push:
    branches: [ "main", "production"]
  workflow_dispatch:
    inputs:
      deployment_reason:
        description: 'ğŸ“ Reason for manual deployment'
        required: false
        default: 'Manual deployment using standard pipeline'
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          FIRECRAWL_API_KEY: ${{ secrets.FIRECRAWL_API_KEY }}
          HUGGINGFACE_API_KEY: ${{ secrets.HUGGINGFACE_API_KEY }}
          HUGGING_FACE_ACCESS_TOKEN: ${{ secrets.HUGGING_FACE_ACCESS_TOKEN }}
          JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          MATERIAL_KAI_API_KEY: ${{ secrets.MATERIAL_KAI_API_KEY }}
          MATERIAL_KAI_API_URL: ${{ secrets.MATERIAL_KAI_API_URL }}
          MATERIAL_KAI_CLIENT_ID: ${{ secrets.MATERIAL_KAI_CLIENT_ID }}
          MATERIAL_KAI_CLIENT_SECRET: ${{ secrets.MATERIAL_KAI_CLIENT_SECRET }}
          MATERIAL_KAI_WEBHOOK_SECRET: ${{ secrets.MATERIAL_KAI_WEBHOOK_SECRET }}
          MATERIAL_KAI_WORKSPACE_ID: ${{ secrets.MATERIAL_KAI_WORKSPACE_ID }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}

      # 2. Setup SSH
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      # 3. Deployment Overview & Summary
      - name: ğŸ“‹ Deployment Overview & Summary
        run: |
          echo "ğŸš€ MIVAA PDF Extractor Deployment Overview (DEFAULT)"
          echo "=================================================="
          echo ""
          echo "ğŸ¯ Deployment Type: STANDARD (Default Pipeline)"
          echo "ğŸ“ Trigger: ${{ github.event_name == 'push' && 'Automatic (Code Push)' || 'Manual (workflow_dispatch)' }}"
          echo "${{ github.event.inputs.deployment_reason && format('ğŸ“ Reason: {0}', github.event.inputs.deployment_reason) || '' }}"
          echo ""
          echo "ğŸ“Š Deployment Details:"
          echo "  â€¢ Target Environment: Production"
          echo "  â€¢ Target Server: 104.248.68.3"
          echo "  â€¢ Branch: ${{ github.ref_name }}"
          echo "  â€¢ Commit: ${{ github.sha }}"
          echo "  â€¢ Triggered by: ${{ github.actor }}"
          echo "  â€¢ Deployment ID: ${{ github.run_id }}"

          # Add to GitHub Step Summary (visible on main action page)
          echo "# ğŸš€ MIVAA Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š Deployment Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸ¯ Deployment Type** | STANDARD (Default Pipeline) |" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸ“ Trigger** | ${{ github.event_name == 'push' && 'Automatic (Code Push)' || 'Manual (workflow_dispatch)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸŒ¿ Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸ“‹ Commit** | [\`${{ github.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸ‘¤ Triggered by** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸ†” Deployment ID** | \`${{ github.run_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸ¯ Target Environment** | Production |" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸ–¥ï¸ Target Server** | 104.248.68.3 |" >> $GITHUB_STEP_SUMMARY
          echo "| **â° Started** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Add reason if provided
          if [[ -n "${{ github.event.inputs.deployment_reason }}" ]]; then
            echo "| **ğŸ“ Deployment Reason** | ${{ github.event.inputs.deployment_reason }} |" >> $GITHUB_STEP_SUMMARY
          fi
          echo ""
          echo "ğŸ—ï¸ Application Architecture:"
          echo "  â€¢ Service: MIVAA PDF Extractor (FastAPI)"
          echo "  â€¢ Runtime: Python 3.9 with pyenv"
          echo "  â€¢ Package Manager: uv (ultrafast Python package installer)"
          echo "  â€¢ Process Manager: systemd (mivaa-pdf-extractor.service)"
          echo "  â€¢ Deployment Path: /var/www/mivaa-pdf-extractor"
          echo ""
          echo "ğŸ”§ Key Components:"
          echo "  â€¢ PDF Processing: PyMuPDF + pymupdf4llm"
          echo "  â€¢ AI/ML: LlamaIndex, OpenAI, HuggingFace, Replicate"
          echo "  â€¢ Database: Supabase (PostgreSQL)"
          echo "  â€¢ Authentication: JWT with custom middleware"
          echo "  â€¢ Monitoring: Sentry error tracking"
          echo "  â€¢ API Endpoints: 37+ endpoints across 7 modules"

          # Add architecture to summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ—ï¸ Application Architecture" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸš€ Service** | MIVAA PDF Extractor (FastAPI) |" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸ Runtime** | Python 3.9 with pyenv |" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸ“¦ Package Manager** | uv (ultrafast Python package installer) |" >> $GITHUB_STEP_SUMMARY
          echo "| **âš™ï¸ Process Manager** | systemd (mivaa-pdf-extractor.service) |" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸ“ Deployment Path** | /var/www/mivaa-pdf-extractor |" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸ“„ PDF Processing** | PyMuPDF + pymupdf4llm |" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸ¤– AI/ML** | LlamaIndex, OpenAI, HuggingFace, Replicate |" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸ—„ï¸ Database** | Supabase (PostgreSQL) |" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸ” Authentication** | JWT with custom middleware |" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸ“Š Monitoring** | Sentry error tracking |" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸŒ API Endpoints** | 37+ endpoints across 7 modules |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo ""
          echo "ğŸ” Environment Variables (Configured):"
          echo "  â€¢ SUPABASE_URL: âœ… Configured"
          echo "  â€¢ SUPABASE_ANON_KEY: âœ… Configured"
          echo "  â€¢ SUPABASE_SERVICE_ROLE_KEY: âœ… Configured"
          echo "  â€¢ ANTHROPIC_API_KEY: âœ… Configured"
          echo "  â€¢ OPENAI_API_KEY: âœ… Configured"
          echo "  â€¢ HUGGINGFACE_API_KEY: âœ… Configured"
          echo "  â€¢ REPLICATE_API_TOKEN: âœ… Configured"
          echo "  â€¢ JWT_SECRET_KEY: âœ… Configured"
          echo "  â€¢ SENTRY_DSN: âœ… Configured"
          echo "  â€¢ MATERIAL_KAI_API_*: âœ… Configured"
          echo ""
          echo "ğŸ“¦ Deployment Process:"
          echo "  1. ğŸ“¥ Code checkout and SSH setup"
          echo "  2. ğŸ”„ Git repository sync on server"
          echo "  3. ğŸ Python environment setup (pyenv + venv)"
          echo "  4. ğŸ“‹ Dependency compilation (uv.lock generation)"
          echo "  5. âš¡ Ultra-fast dependency installation (uv)"
          echo "  6. âœ… Critical dependency verification"
          echo "  7. ğŸ”„ Service restart (systemd)"
          echo "  8. ğŸ¥ Health check and status verification"
          echo ""
          echo "ğŸ¯ Expected Outcomes:"
          echo "  â€¢ Zero-downtime deployment"
          echo "  â€¢ All 37+ API endpoints operational"
          echo "  â€¢ PDF processing capabilities active"
          echo "  â€¢ AI/ML models ready for inference"
          echo "  â€¢ Database connections established"
          echo "  â€¢ Authentication system functional"
          echo ""
          echo "â±ï¸ Starting deployment process..."
          echo ""

      # 4. Deploy to server
      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no root@104.248.68.3 << 'EOF'
          set -e

          APP_DIR=/var/www/mivaa-pdf-extractor
          DEPLOY_BRANCH="${{ github.ref_name }}"

          # Clone repo if it doesn't exist
          if [ ! -d "$APP_DIR/.git" ]; then
            rm -rf "$APP_DIR"
            git clone https://x-access-token:${{ secrets.GH_PAT }}@github.com/creativeghq/mivaa-pdf-extractor.git "$APP_DIR"
          fi

          cd "$APP_DIR"

          # Pull latest changes for the branch
          git fetch origin "$DEPLOY_BRANCH"
          git reset --hard origin/"$DEPLOY_BRANCH"

          # --- Initialize pyenv ---
          export PATH="$HOME/.pyenv/bin:$PATH"
          eval "$(pyenv init --path)"
          eval "$(pyenv init -)"
          eval "$(pyenv virtualenv-init -)"

          # Use pyenv Python
          PYTHON=python3.9

          # --- Create virtual environment ---
          if [ ! -d ".venv" ] || [ ! -f ".venv/pyvenv.cfg" ]; then
            rm -rf .venv
            $PYTHON -m venv .venv
          fi

          # Activate venv
          source .venv/bin/activate

          # --- Ensure pip and uv are installed ---
          python -m ensurepip --upgrade
          pip install --upgrade pip
          pip install uv

          # --- Generate uv.lock dynamically ---
          uv pip compile -o uv.lock requirements.txt requirements-torch.txt

          # --- Sync dependencies ---
          uv pip sync uv.lock

          # --- Verify installations ---
          python -c "import fastapi; print('FastAPI OK')"
          python -c "import pymupdf; print('PyMuPDF OK')"
          python -c "import pymupdf4llm; print('pymupdf4llm OK')"

          # Restart the FastAPI service
          sudo systemctl restart mivaa-pdf-extractor

          # Check service status
          sudo systemctl status mivaa-pdf-extractor --no-pager
          EOF

      # 5. Post-Deployment Summary
      - name: ğŸ“Š Deployment Summary & Health Check
        run: |
          echo ""
          echo "ğŸ‰ MIVAA PDF Extractor Deployment Complete!"
          echo "=========================================="
          echo ""
          echo "âœ… Deployment Status: SUCCESS"
          echo "ğŸ“… Completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ Duration: Approximately 2-3 minutes"

          # Add deployment results to summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ‰ Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| **âœ… Status** | SUCCESS |" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸ“… Completed** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| **â±ï¸ Duration** | ~2-3 minutes |" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸ”„ Service Status** | Active and running |" >> $GITHUB_STEP_SUMMARY
          echo "| **âš™ï¸ Process Manager** | systemd |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo ""
          echo "ğŸŒ Service Information:"
          echo "  â€¢ Server: 104.248.68.3"
          echo "  â€¢ Service: mivaa-pdf-extractor.service"
          echo "  â€¢ Status: Active and running"
          echo "  â€¢ Process Manager: systemd"
          echo ""
          echo "ğŸ”— API Endpoints Available:"
          echo "  â€¢ Health Check: http://104.248.68.3:8000/health"
          echo "  â€¢ API Documentation: http://104.248.68.3:8000/docs"
          echo "  â€¢ OpenAPI Schema: http://104.248.68.3:8000/openapi.json"
          echo "  â€¢ PDF Processing: http://104.248.68.3:8000/api/v1/pdf/*"
          echo "  â€¢ AI Analysis: http://104.248.68.3:8000/api/v1/ai/*"
          echo "  â€¢ Vector Search: http://104.248.68.3:8000/api/v1/search/*"

          # Add API endpoints to summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸŒ Service Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸ¥ Health Check** | [http://104.248.68.3:8000/health](http://104.248.68.3:8000/health) | ğŸŸ¢ Available |" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸ“š API Documentation** | [http://104.248.68.3:8000/docs](http://104.248.68.3:8000/docs) | ğŸŸ¢ Available |" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸ“– ReDoc** | [http://104.248.68.3:8000/redoc](http://104.248.68.3:8000/redoc) | ğŸŸ¢ Available |" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸ“‹ OpenAPI Schema** | [http://104.248.68.3:8000/openapi.json](http://104.248.68.3:8000/openapi.json) | ğŸŸ¢ Available |" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸ“„ PDF Processing** | http://104.248.68.3:8000/api/v1/pdf/* | ğŸŸ¢ Available |" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸ¤– AI Analysis** | http://104.248.68.3:8000/api/v1/ai/* | ğŸŸ¢ Available |" >> $GITHUB_STEP_SUMMARY
          echo "| **ğŸ” Vector Search** | http://104.248.68.3:8000/api/v1/search/* | ğŸŸ¢ Available |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo ""
          echo "ğŸ§ª Quick Health Check Commands:"
          echo "  curl http://104.248.68.3:8000/health"
          echo "  curl http://104.248.68.3:8000/docs"
          echo ""
          echo "ğŸ“‹ Deployment Verification:"
          echo "  â€¢ âœ… Code updated to latest commit"
          echo "  â€¢ âœ… Python environment refreshed"
          echo "  â€¢ âœ… Dependencies synchronized with uv"
          echo "  â€¢ âœ… Critical imports verified (FastAPI, PyMuPDF, pymupdf4llm)"
          echo "  â€¢ âœ… Service restarted successfully"
          echo "  â€¢ âœ… systemd reports service as active"
          echo ""
          echo "ğŸ”§ Troubleshooting (if needed):"
          echo "  â€¢ SSH: ssh root@104.248.68.3"
          echo "  â€¢ Logs: sudo journalctl -u mivaa-pdf-extractor -f"
          echo "  â€¢ Status: sudo systemctl status mivaa-pdf-extractor"
          echo "  â€¢ Restart: sudo systemctl restart mivaa-pdf-extractor"
          echo "  â€¢ App Directory: cd /var/www/mivaa-pdf-extractor"
          echo ""
          echo "ğŸ“ˆ Next Steps:"
          echo "  1. Verify API endpoints are responding"
          echo "  2. Test PDF processing functionality"
          echo "  3. Monitor application logs for any issues"
          echo "  4. Update any dependent services if needed"
          echo ""
          echo "ğŸ¯ Deployment completed successfully! ğŸš€"

          # Add quick actions to summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸš€ Quick Actions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ [**Access Application**](http://104.248.68.3:8000)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¥ [**Check Health**](http://104.248.68.3:8000/health)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“š [**View API Docs**](http://104.248.68.3:8000/docs)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“– [**View ReDoc**](http://104.248.68.3:8000/redoc)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ” [**View Commit**](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Add troubleshooting section
          echo "## ğŸ”§ Troubleshooting" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Health Check" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "curl http://104.248.68.3:8000/health" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SSH Access" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "ssh root@104.248.68.3" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Service Management" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "sudo systemctl status mivaa-pdf-extractor" >> $GITHUB_STEP_SUMMARY
          echo "sudo systemctl restart mivaa-pdf-extractor" >> $GITHUB_STEP_SUMMARY
          echo "sudo journalctl -u mivaa-pdf-extractor -f" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Add footer
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ğŸš€ **MIVAA Default Deployment Pipeline** | ğŸ• Generated: $(date) | ğŸ“‹ ID: \`${{ github.run_id }}\`" >> $GITHUB_STEP_SUMMARY
